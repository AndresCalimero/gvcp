var url="localhost",request=$.ajax({url:url.match(/\/$/)?url+"stun-turn-servers":url+"/stun-turn-servers",method:"GET"});request.done(function(e){function n(){var e=$("#btn-input").val();e.trim().length>0&&(u.sendToAll("chat",{message:e.trim()}),o(e.trim()),$("#btn-input").val(""))}function t(e,n){if(e&&e.pc){var t=$("#usersContainer"),o=$('<div><video muted autoplay oncontextmenu="return false;" src='+n+"></video></div>"),i=$("<div></div>").addClass("userContainer").prop("id","userContainer_"+e.id).append(o),s=$('<div><span class="userNumber"><b>'+c[e.id].name+"</b></span><br />Status: </div>"),l=$("<span></span>").addClass("connectionstate");s.append(l),i.append(s),e.pc.on("iceConnectionStateChange",function(n){switch(e.pc.iceConnectionState){case"checking":i.prop("class","userContainer connecting-to-peer"),l.text("Connecting to peer...");break;case"connected":case"completed":i.prop("class","userContainer connection-established"),l.text("Connection established.");break;case"disconnected":i.prop("class","userContainer disconnected"),l.text("Disconnected.");break;case"failed":i.prop("class","userContainer connection-failed"),l.text("Connection failed.");break;case"closed":i.prop("class","userContainer connection-closed"),l.text("Connection closed.")}}),t.append(i),a()}}function o(e,n){e=$("<div>").text(e).html();var t=new Date,o=t.getHours()+":"+t.getMinutes(),a=$("#chat-list li").last();if(1==a.length&&(void 0===n&&a.hasClass("chat_me")||a.hasClass("chat_"+n))){var i=a.find(".chat-body p"),s=i.html()+"<br />"+e;i.html(s),a.find(".header small").contents().last().replaceWith(o)}else{var l;l=void 0===n?$('<li class="right clearfix chat_me"><span class="chat-img pull-right"><div style="background-color:'+r[0]+';"><span>Me</span></div></span><div class="chat-body clearfix"><div class="header"><small class=" text-muted"><span class="glyphicon glyphicon-time"></span>'+o+'</small><strong class="pull-right primary-font">Me</strong></div><p>'+e+"</p></div></li>"):$('<li class="left clearfix chat_'+n+'"><span class="chat-img pull-left"><div style="background-color:'+r[c[n].number]+';"><span>U'+c[n].number+'</span></div></span><div class="chat-body clearfix"><div class="header"><strong class="primary-font">'+c[n].name+'</strong> <small class="pull-right text-muted"><span class="glyphicon glyphicon-time"></span>'+o+"</small></div><p>"+e+"</p></div></li>"),$("#chat-list").append(l)}var d=$(".leftMenu .panel .panel-body"),u=d[0].scrollHeight;d.scrollTop(u)}function a(){var e;if(0==c.numRemotes)e=$(".leftMenu").height()-$(".leftMenu .panel-footer").outerHeight(!0);else{e=$(".leftMenu").height()-$(".leftMenu .panel-footer").outerHeight(!0)-$(".leftMenu .panel-heading").outerHeight(!0)-$("#usersContainer").outerHeight(!0)}$(".leftMenu .container .panel-body").css("height",e)}function i(){if(void 0!==s){$(".localVideoContainer").removeAttr("style");var e=$(".localVideoContainer").height(),n=100*e/s.videoHeight,t=s.videoWidth*(n/100);$(".localVideoContainer").css("width",t),$(".localVideoContainer").css("height",e)}}e=JSON.parse(e);var s,l,r=["#FF9000","#32CD32","#4682B4","#C71585"],c={numRemotes:0},d=location.search&&location.search.split("?")[1];d&&(l=d.substr(d.indexOf("room=")+5)),a(),$(".leftMenu .container").css("visibility","visible"),$(window).resize(function(){a(),i()});var u=new SimpleWebRTC({localVideoEl:"localVideo",remoteVideosEl:"",autoRequestMedia:!0,debug:!1,detectSpeakingEvents:!0,autoAdjustMic:!1,peerConnectionConfig:e,url:url});u.on("readyToCall",function(){l&&u.joinRoom(l,function(e){e&&"full"==e&&bootbox.alert({title:"The room is full!",message:"Sorry, this room has reached its maximum capacity.",callback:function(){location="/"}})})}),u.on("localStream",function(e){$("#localVideo").bind("loadedmetadata",function(){s=this,i()})}),u.on("localMediaError",function(e){e&&bootbox.dialog({title:"We can not access the media!",message:"You must give permission to this site to make use of the webcam and microphone if you want to join a room.",buttons:{danger:{label:"Exit",className:"btn-danger",callback:function(){location="/"}},main:{label:"Retry",className:"btn-primary",callback:function(){location.reload()}}}})}),u.on("videoAdded",function(e,n){c.numRemotes+=1,c[n.id]={name:"User #"+c.numRemotes,number:c.numRemotes};var o=$("#remotes");if(1==o.length){var a="videoContainer-"+c.numRemotes;if(c.numRemotes>1){var i="videoContainer-"+(c.numRemotes-1);$("#remotes").children().toggleClass(i+" "+a)}var s=$("<div></div>").addClass(a).prop("id","container_"+n.id).append(e);e.oncontextmenu=function(){return!1},t(n,e.src),o.append(s)}}),u.on("videoRemoved",function(e,n){delete c[n.id],c.numRemotes-=1;var t=1;for(var o in c)c.hasOwnProperty(o)&&"numRemotes"!=o&&(c[o].name="User #"+t,c[o].number=t++,$("#userContainer_"+o).find(".userNumber").html("<b>"+c[o].name+"</b>"));if($("#container_"+n.id).remove(),$("#userContainer_"+n.id).remove(),c.numRemotes>0){var i="videoContainer-"+c.numRemotes,s="videoContainer-"+(c.numRemotes+1);$("#remotes").children().toggleClass(s+" "+i)}a()}),u.on("iceFailed",function(e){bootbox.dialog({title:"Connection failure!",message:"A problem occurred while attempting a connection with all peers.",buttons:{danger:{label:"Exit room",className:"btn-danger",callback:function(){location="/"}},main:{label:"Retry",className:"btn-primary",callback:function(){location.reload()}}}})}),u.on("connectivityError",function(e){var n=$("#userContainer_"+e.id+" > .connectionstate");console.log("remote fail",n),n&&n.text("Connection failed.")}),u.on("speaking",function(e){u.sendToAll("speaking")}),u.on("stoppedSpeaking",function(e){u.sendToAll("stoppedSpeaking")}),u.connection.on("message",function(e){"chat"===e.type?o(e.payload.message,e.from):"speaking"===e.type?$("#userContainer_"+e.from).addClass("speaking"):"stoppedSpeaking"===e.type&&$("#userContainer_"+e.from).toggleClass("speaking")}),$("#btn-input").keyup(function(e){13==e.keyCode&&n()}),$("#btn-chat").click(function(){n()}),l?function(e){$("#title").text("Room: "+e),$("#subTitle").html("Link to join: <b>"+location.href+"</b>")}(l):location="/"});